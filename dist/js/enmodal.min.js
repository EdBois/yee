/*! enmodal - v0.1.0 - 2017-07-22
* http://enmodal.co/
* Copyright (c) 2017 Jason Wright; Licensed MIT */

function handle_map_click(t){if(null!=enmodal.transit_interface.active_line&&"station"==enmodal.transit_interface.active_tool){var e=enmodal.transit_interface.pin_projection(t.latlng.lat,t.latlng.lng);e[0]?enmodal.transit_interface.get_station_pair_by_sp_id(e[2]).add_pin(e[1].x,e[1].y):enmodal.transit_interface.add_new_station(t.latlng.lat,t.latlng.lng)}"transfer"==enmodal.transit_interface.active_tool&&(enmodal.transit_interface.active_tool="station",enmodal.transit_interface.preview_clear())}function init_leaflet_map(){var t=L.map("map",{fullscreenControl:!0,attributionControl:!1}).setView([40.713,-74.006],START_ZOOM);return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"",maxZoom:MAX_ZOOM,minZoom:MIN_ZOOM}).addTo(t),t.on("click",handle_map_click),t}function init_document(){$(document).on("click",".station-delete",delete_station_event),$(document).on("click",".station-transfer",transfer_station_event),$(document).on("click",".station-build",build_to_station_event),$(document).on("click",".subway-deletable",function(){var t=parseInt($(this).attr("transit-line-id")),e=parseInt($(this).attr("transit-station-id"));enmodal.transit_interface.remove_line_from_station(e,t)}),$(document).on("click",".station-name",function(){var t=$(this).text(),e=$(this);$(this).text(""),$('<textarea class="station-name-edit"></textarea>').appendTo($(this)).val(t).select().blur(function(){var t=$(this).val();$(this).parent().text(t).find("textarea").remove();var s=e.attr("id").replace("station-",""),i=enmodal.transit_interface.active_service.get_station_by_id(s);i.name=t,enmodal.sidebar.update_line_diagram(),enmodal.transit_interface.sync_station_info(i),enmodal.transit_interface.get_station_marker_by_station(i).update_tooltip()})}),$(document).on("click",".subway-clickable",function(){return line_select_click_handler($(this)),!1}),$(document).on("click",".route-diagram-stop-info",function(){var t=$(this).attr("id").replace("station-",""),e=enmodal.transit_map.get_station_by_id(t),s=enmodal.transit_interface.get_station_marker_by_station(e);s.generate_popup(),s.marker.openPopup(),enmodal.leaflet_map.panTo(s.marker.getLatLng())}),$("#custom-line-name").keyup(function(){enmodal.sidebar.update_line_editor(),enmodal.sidebar.line_editor_save()}),$("#line-selector-new").click(function(){enmodal.sidebar.line_selector_new()}),$(document).on("click",".line-selector-option",function(t){enmodal.sidebar.update_line_selector(parseInt(t.currentTarget.getAttribute("transit-line-id")))}),$("#custom-service-name").keyup(function(){enmodal.sidebar.service_editor_save()}),$("#service-selector-new").click(function(){enmodal.sidebar.service_selector_new()}),SERVICE_MODES_ENABLED&&$(".service-mode-button").click(function(){var t=$(this).attr("transit-service-mode");enmodal.transit_interface.active_service.mode=t,enmodal.sidebar.update_service_selector(enmodal.transit_interface.active_service.sid,!0)}),$(document).on("click",".service-selector-option",function(t){enmodal.sidebar.update_service_selector(parseInt(t.currentTarget.getAttribute("transit-service-id")),!0)}),$(".subway-hidden").hide(),$("#custom-lines").hide(),$("#game-start-scratch").click(function(){$("#starter-city-picker").hide(),$("#starter").hide()}),$("#city-picker-input").autocomplete({source:function(t,e){if(is_latlng(t.term)){var s=get_latlng(t.term);enmodal.leaflet_map.panTo(L.latLng(s[0],s[1]))}else $.ajax({url:"http://search.mapzen.com/v1/autocomplete?api_key=mapzen-t6h4cff&layers=locality&text="+t.term,dataType:"json",success:function(t){e($.map(t.features,function(t){if("USA"==t.properties.country_a)return{label:t.properties.locality+", "+t.properties.region_a,value:t.geometry}}))}})},select:function(t,e){return $("#city-picker-input").val(e.item.label),enmodal.transit_interface.map.panTo(L.latLng(e.item.value.coordinates[1],e.item.value.coordinates[0])),!1},minLength:3}),$("#custom-line-options #color-picker-bg").spectrum({color:DEFAULT_LINE_BG,showInput:!0,className:"full-spectrum",showInitial:!0,maxSelectionSize:10,preferredFormat:"hex",change:function(t){enmodal.sidebar.update_line_editor(),enmodal.sidebar.line_editor_save()}}),$("#custom-line-options #color-picker-fg").spectrum({color:DEFAULT_LINE_FG,showInput:!0,className:"full-spectrum",showInitial:!0,maxSelectionSize:10,preferredFormat:"hex",change:function(t){enmodal.sidebar.update_line_editor(),enmodal.sidebar.line_editor_save()}}),null!=enmodal.transit_interface.active_line&&enmodal.sidebar.refresh_line_editor(),$("#tool-station").addClass("game-button-active"),$("#tool-station").click(function(t){"station"!=enmodal.transit_interface.active_tool&&($(".tool-button").removeClass("game-button-active"),$("#tool-station").addClass("game-button-active"),$("#option-section-services").show(),$("#option-section-lines").show(),$("#option-section-route").show(),$("#option-section-visual").hide(),$("#option-section-data").hide(),enmodal.transit_interface.layers.preview.clearLayers(),enmodal.transit_interface.active_tool="station")}),$("#tool-data").click(function(t){"data"!=enmodal.transit_interface.active_tool&&($(".tool-button").removeClass("game-button-active"),$("#tool-data").addClass("game-button-active"),$("#option-section-services").hide(),$("#option-section-lines").hide(),$("#option-section-route").hide(),$("#option-section-visual").hide(),$("#option-section-data").show(),enmodal.transit_interface.layers.preview.clearLayers(),enmodal.transit_interface.active_tool="data")}),$(".data-layer-selector").click(function(t){$(this).hasClass("data-layer-selected")?(enmodal.data.active=null,$("#scale").hide(),$(".data-layer-selector").removeClass("data-layer-selected"),enmodal.transit_interface.layers.data.clearLayers()):($(".data-layer-selector").removeClass("data-layer-selected"),$(this).addClass("data-layer-selected"),"data-layer-population"==$(this).attr("id")&&(enmodal.data.hide_layers(),enmodal.data.draw_layer_population(!0)),"data-layer-employment"==$(this).attr("id")&&(enmodal.data.hide_layers(),enmodal.data.draw_layer_employment(!0)),"data-layer-ridership"==$(this).attr("id")&&(enmodal.data.hide_layers(),enmodal.data.draw_layer_ridership()))}),$("#tool-save").click(function(t){session_save()}),$("#tool-share").click(function(t){$("#starter-share").show(),$("#starter").show()}),$("#share-ok").click(function(t){$("#starter-share").hide(),$("#starter").hide()}),new Clipboard(".share-link-copy-button")}function sortNumber(t,e){return t-e}function delete_station_event(t){var e=parseInt($(this).attr("transit-station-id"));enmodal.transit_interface.remove_station(e)}function transfer_station_event(t){var e=$(this).attr("id").replace("transfer-","");enmodal.transit_interface.active_transfer_station=enmodal.transit_interface.active_service.get_station_by_id(e),enmodal.transit_interface.active_tool="transfer"}function build_to_station_event(t){var e=$(this).attr("id");enmodal.transit_interface.add_stop_to_station(e)}function session_new(){$.ajax({url:"session",async:!1,dataType:"json",success:function(t,e){enmodal.session_id=t.private_key,window.history.pushState("","","?id="+enmodal.session_id),enmodal.sharing.update(t.public_key,t.private_key)}});var t=new Service("MTA");t.mode="heavy_rail",enmodal.transit_map.add_service(t),enmodal.transit_interface.active_service=t,enmodal.sidebar.update_service_selector(enmodal.transit_interface.active_service.sid),enmodal.sidebar.refresh_service_editor();var e=$.param({i:enmodal.session_id,service_id:t.sid,name:t.name});$.ajax({url:"service_add?"+e,async:!1,dataType:"json",success:function(t,e){}})}function session_load(){var t=$.param({i:enmodal.session_id});$.ajax({url:"session_load?"+t,async:!1,success:function(t,e){console.log(t);_=JSON.parse(t);if(console.log(_),void 0!=_.error)session_new();else{var s=JSON.parse(_.data);console.log(s),enmodal.session_id=_.private_key,window.history.pushState("","","?id="+enmodal.session_id),enmodal.sharing.update(_.public_key,_.private_key),enmodal.transit_map.sid=s.sid,enmodal.transit_map.from_json(s),enmodal.transit_interface.active_service=enmodal.transit_map.primary_service(),enmodal.transit_interface.active_line=enmodal.transit_map.primary_service().lines[0],enmodal.sidebar.update_service_selector(enmodal.transit_interface.active_service.sid,!0),enmodal.sidebar.refresh_service_editor(),enmodal.sidebar.update_line_selector(enmodal.transit_interface.active_line.sid),enmodal.sidebar.update_line_editor(),enmodal.sidebar.refresh_line_editor(),enmodal.sidebar.update_line_diagram();for(var i=s.settings,a=0;a<i.station_pairs.length;a++){var n=i.station_pairs[a],r=enmodal.transit_map.get_station_by_id(n.station_ids[0]),o=enmodal.transit_map.get_station_by_id(n.station_ids[1]),l=enmodal.transit_interface.get_station_pair(r,o);if(null!=l)for(var _=0;_<n.pins.length;_++)l[0].add_pin(n.pins[_].location[0],n.pins[_].location[1])}enmodal.transit_interface.draw_transfers(),enmodal.transit_interface.map.closePopup(),enmodal.data.get_ridership(),$("#starter-city-picker").hide(),$("#starter").hide()}}})}function session_save(){var t=$.param({i:enmodal.session_id});$.ajax({url:"session_push?"+t,async:!0,type:"POST",data:LZString.compressToUTF16(session_json()),dataType:"text",success:function(t,e){var s=$.param({i:enmodal.session_id});$.ajax({url:"session_save?"+s,async:!0,dataType:"json",success:function(t,e){$("#save-message").fadeIn().delay(2e3).fadeOut()}})}})}function session_json(){var t={map:enmodal.transit_map,settings:enmodal.transit_interface.settings()};return JSON.stringify(t)}function get_url_parameter(t){var e={};return window.location.href.replace(location.hash,"").replace(/[?&]+([^=&]+)=?([^&]*)?/gi,function(t,s,i){e[s]=void 0!==i?i:""}),t?e[t]?e[t].replace(/\#$/,""):null:e}function num_unique_colors(t){for(var e=0,s=[],i=0;i<t.length;i++)-1==s.indexOf(t[i].color_bg)&&(s.push(t[i].color_bg),e+=1);return e}function station_distance(t,e){var s={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[t.location[1],t.location[0]]}},i={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[e.location[1],e.location[0]]}};return turf.distance(s,i,"miles")}function is_latlng(t){return/^(\-)?[0-9]{0,3}.[0-9]*,(\ )?(\-)?[0-9]{0,3}.[0-9]*$/.test(t)}function get_latlng(t){var e=t.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}var _id_factory,_leaflet_map,enmodal;$(function(){_id_factory=new IdFactory,_leaflet_map=init_leaflet_map(),enmodal={session_id:get_url_parameter("id"),sidebar:new Sidebar,sharing:new Sharing,leaflet_map:_leaflet_map,transit_map:new Map,transit_interface:new TransitUI(_leaflet_map),data:new DataLayers,id_factory:_id_factory},init_document(),null!=enmodal.session_id?session_load():session_new()});class Pin{constructor(t){this.location=t,this.sid=_id_factory.id(),this.marker=null}draw(){enmodal.transit_interface.layers.active.line_paths.addLayer(this.marker)}undraw(){enmodal.transit_interface.layers.active.line_paths.removeLayer(this.marker)}toJSON(){return{sid:this.sid,location:this.location}}}class SplineSegment{constructor(t,e){this.controls=t,this.centers=e}}class LineSplineSegment{constructor(t,e,s){this.line=t,this.spline_segments=e,this.reverse=s}}class BezierControlPoint{constructor(t,e){this.lat=t,this.lng=e}}class BezierCenter{constructor(t,e){this.lat=t,this.lng=e}}class DataLayers{constructor(){this.active=null,this.hexagon_bounds=null,this.hexagon_zoom=null}draw_layer_population(t){this.active="population",this.get_hexagons(t)}draw_layer_employment(t){this.active="employment",this.get_hexagons(t)}draw_layer_ridership(){for(var t=-1,e=0,s=0;s<enmodal.transit_interface.active_service.stations.length;s++)(a=(i=enmodal.transit_interface.active_service.stations[s]).ridership)>e&&(e=a),(a<t||-1==t)&&(t=a);for(s=0;s<enmodal.transit_interface.active_service.stations.length;s++){var i=enmodal.transit_interface.active_service.stations[s],a=i.ridership,n=39*(a-t)/(e-t)+1;enmodal.transit_interface.layers.data.addLayer(L.circleMarker(i.location,{color:"red",radius:n}))}$("#scale-boxes").empty();for(s=0;s<10;s++)$("#scale-boxes").append('<div class="scale-box"><div class="scale-inner" style="width: '+(2*(s+1)).toString()+"px; height: "+(2*(s+1)).toString()+"px; top: "+(20-(s+1)).toString()+'px;"></div>');$("#scale-low").text(Math.round(t)),$("#scale-mid").text(Math.round((e-t)/2+t)),$("#scale-high").text(Math.round(e)),$("#scale-units").html("weekday riders"),$("#scale").show()}draw_active_layer(t){"population"==this.active&&this.draw_layer_population(t),"employment"==this.active&&this.draw_layer_employment(t),"ridership"==this.active&&this.draw_layer_ridership()}get_ridership(){var t=$.param({i:enmodal.session_id});$.ajax({url:"transit_model?"+t,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){for(var s in t){var i=t[s],a=enmodal.transit_interface.active_service.get_station_by_id(parseInt(s));null!=a&&(a.ridership=i,$("#stationriders-"+a.sid.toString()).text(Math.round(a.ridership).toString()))}}})}quantiles(t,e,s){for(var i=[],a=0;a<t.features.length;a++)i.push(t.features[a].properties[s]);i.sort(sortNumber);var n=[],r=i.length-1;r-=Math.round(i.length/e);for(var o=0;o<=e;o++)n.push(i[r]),(r-=Math.round(i.length/e))<0&&(r=0);return n}population_color(t,e,s){for(var i=e.length-1,a=0;a<i;a++)if(t>=e[a])return s(a/i).hex();return s[i-1]}get_hexagons(t){var e=enmodal.leaflet_map.getBounds(),s=e.pad(.5),i=!0;null!=this.hexagon_bounds&&null!=this.hexagon_zoom&&this.hexagon_bounds.contains(e)&&enmodal.transit_interface.map.getZoom()==this.hexagon_zoom&&(i=!1),enmodal.transit_interface.map.getZoom()<MIN_ZOOM&&(i=!1);enmodal.transit_interface.data_layer_request_num;if(t&&(i=!0),i){this.hexagon_bounds=s,this.hexagon_zoom=enmodal.transit_interface.map.getZoom();var a=$.param({i:enmodal.session_id,lat_min:s.getSouth(),lat_max:s.getNorth(),lng_min:s.getWest(),lng_max:s.getEast()});$.ajax({url:"get_hexagons?"+a,async:ASYNC_REQUIRED,dataType:"text",success:function(t,e){var s=JSON.parse(t),i=enmodal.data.quantiles(s,8,enmodal.data.active),a=HEXAGON_SCALES[enmodal.data.active];$("#scale-boxes").empty();for(var n=0;n<8;n++)$("#scale-boxes").append('<div class="scale-box" style="background-color: '+a((8-n)/8).hex()+' "></div>');$("#scale-low").text("0"),$("#scale-mid").text(Math.round(i[Math.round(3.5)]/DGGRID_AREA).toString()),$("#scale-high").text(Math.round(i[0]/DGGRID_AREA).toString()),$("#scale-units").html(HEXAGON_UNITS[enmodal.data.active]),$("#scale").show(),enmodal.transit_interface.layers.data.clearLayers(),enmodal.leaflet_map.getZoom()<14?enmodal.transit_interface.layers.data.addLayer(L.vectorGrid.slicer(s,{vectorTileLayerStyles:{sliced:function(t,e){var s=0;return"population"==enmodal.data.active&&(s=t.population),"employment"==enmodal.data.active&&(s=t.employment),{fillColor:enmodal.data.population_color(s,i,a),fill:!0,weight:0,opacity:1,color:"white",fillOpacity:.35}}}})):enmodal.transit_interface.layers.data.addLayer(L.geoJson(s,{style:function(t){var e=0;return"population"==enmodal.data.active&&(e=t.properties.population),"employment"==enmodal.data.active&&(e=t.properties.employment),{fillColor:enmodal.data.population_color(e,i,a),weight:0,opacity:1,color:"white",fillOpacity:.35}}})),enmodal.transit_interface.layers.active.line_paths.bringToFront(),enmodal.leaflet_map.setMinZoom(MIN_ZOOM)}})}}hide_layers(){this.active=null,enmodal.transit_interface.layers.data.clearLayers()}}class LinePath{constructor(){this.raw_edge_paths=[],this.edge_paths=[]}get_path_for_edge(t){for(var e=0;e<this.edge_paths.length;e++)if(this.edge_paths[e].edge_id==t.sid)return this.edge_paths[e];return null}get_raw_path_for_edge(t){for(var e=0;e<this.raw_edge_paths.length;e++)if(this.raw_edge_paths[e].edge_id==t.sid)return this.raw_edge_paths[e];return null}}class EdgePath{constructor(t,e,s,i,a,n){this.edge_id=t,this.stop_points=e,this.control_points=s,this.custom_control_points=[],this.offset=i,this.color=a,this.opacity=n,this.track_width=6,this.path=this.generate_path(this.color,this.opacity)}generate_path(t,e){if(0==this.control_points.length)r=L.polyline([L.latLng(this.stop_points[0][0],this.stop_points[0][1]),L.latLng(this.stop_points[1][0],this.stop_points[1][1])],{weight:this.track_width,color:t,opacity:e});else if(0==this.control_points[0].length)r=L.polyline([L.latLng(this.stop_points[0][0],this.stop_points[0][1]),L.latLng(this.stop_points[1][0],this.stop_points[1][1])],{weight:this.track_width,color:t,opacity:e});else{for(var s=["M",[this.stop_points[0][0],this.stop_points[0][1]]],i=0;i<this.control_points.length;i++){var a=["C",[this.control_points[i][0].lng,this.control_points[i][0].lat],[this.control_points[i][1].lng,this.control_points[i][1].lat],[this.stop_points[i+1][0],this.stop_points[i+1][1]]];s.push.apply(s,a)}var n={color:t,weight:this.track_width,opacity:e,fill:!1,smoothFactor:1,offset:this.offset*(this.track_width/2),clickable:!1,"pointer-events":"none",className:"no-hover"},r=L.curve(s,n)}return r}regenerate_path(){this.path=this.generate_path(this.color,this.opacity)}}class LineColor{constructor(t,e,s){this.r=t,this.g=e,this.b=s,this.fr=255,this.fg=255,this.fb=255,t+e+s>382.5&&(this.fr=0,this.fg=0,this.fb=0)}bg_hex(){return"#"+("0"+this.r.toString(16).toUpperCase()).slice(-2)+("0"+this.g.toString(16).toUpperCase()).slice(-2)+("0"+this.b.toString(16).toUpperCase()).slice(-2)}fg_hex(){return"#"+("0"+this.fr.toString(16).toUpperCase()).slice(-2)+("0"+this.fg.toString(16).toUpperCase()).slice(-2)+("0"+this.fb.toString(16).toUpperCase()).slice(-2)}}class Hexagon{constructor(t,e,s,i){this.sid=t,this.geo=e,this.color=s,this.opacity=i,this.style=this.generate_style(),this.poly=this.generate_poly()}generate_poly(){return L.geoJSON(this.geo,{style:this.style})}update_poly(){this.poly=this.generate_poly()}generate_style(){return{color:this.color,stroke:!1,fillOpacity:this.opacity}}update_style(){this.style=this.generate_style(),this.poly.setStyle(this.style)}draw(){NS_interface.data_layer.addLayer(this.poly)}}class TransitUI{constructor(t){this.active_service=null,this.active_line=null,this.station_markers=[],this.line_paths={},this.station_pairs=[],this.preview_paths=[],this.map=t,this.active_tool="station",this.data_layer_request_num=0,this.preview_paths_enabled=!0,this.nearest_station_to_mouse=null,this.station_for_bezier_edits=null,this.moving_station_marker=null,this.station_to_merge=null,this.dragging_pin=!1,this.station_pair_id_move_count_map={},this.preview_line_pin_marker=null,this.active_transfer_station=null,this.pane_station_markers=this.map.createPane("stationMarkerPane"),this.pane_station_markers=this.map.createPane("inactiveStationMarkerPane"),this.layers={active:{line_paths:L.featureGroup(),transfers:L.featureGroup(),station_markers:L.featureGroup({pane:"stationMarkerPane"})},inactive:{line_paths:L.featureGroup(),transfers:L.featureGroup(),station_markers:L.featureGroup({pane:"inactiveStationMarkerPane"})},preview:L.featureGroup(),data:L.featureGroup()},this.hexagons={},this.chroma_scale=chroma.scale("YlGnBu"),this.map.addLayer(this.layers.data),this.map.addLayer(this.layers.active.line_paths),this.map.addLayer(this.layers.active.transfers),this.map.addLayer(this.layers.active.station_markers),this.map.addLayer(this.layers.inactive.line_paths),this.map.addLayer(this.layers.inactive.transfers),this.map.addLayer(this.layers.inactive.station_markers),this.map.addLayer(this.layers.preview),this.map.on("mouseup",()=>{if(this.map.dragging.enable(),this.map.removeEventListener("mousemove"),this.preview_paths_enabled=!0,this.map.on("mousemove",function(t){enmodal.transit_interface.preview_handler(t)}),null!=this.moving_station_marker){if(null!=this.station_to_merge?(this.merge_stations(this.moving_station_marker.station,this.station_to_merge),this.station_to_merge=null):(this.update_station_info(this.moving_station_marker.station),this.moving_station_marker.update_tooltip(),this.moving_station_marker.generate_popup(),this.moving_station_marker.marker.openPopup()),"bus"==this.active_service.mode)for(var t=this.active_service.station_lines(this.moving_station_marker.station),e=0;e<t.length;e++){for(var s=enmodal.transit_interface.get_station_pairs_for_line(t[e]),i=0;i<s.length;i++)s[i].draw_counter=FOLLOW_STREET_MOVE_THRESH;this.draw_line(t[e],!1,!0,this.layers.active.line_paths,!0,this.active_service)}this.moving_station_marker=null,this.purge_bad_transfers(),enmodal.sidebar.update_line_diagram()}}),this.map.on("mousemove",function(t){enmodal.transit_interface.preview_handler(t)}),this.map.on("moveend",function(t){enmodal.data.draw_active_layer(!1)})}draw_service(t,e,s,i){if(i&&(e.station_markers.clearLayers(),this.station_markers=[],e.line_paths.clearLayers(),this.layers.inactive.station_markers.clearLayers(),this.layers.inactive.line_paths.clearLayers()),s)for(n=0;n<enmodal.transit_map.services.length;n++)enmodal.transit_map.services[n].sid!=t.sid&&this.draw_service(enmodal.transit_map.services[n],this.layers.inactive,!1,!1);for(n=0;n<t.stations.length;n++){var a=t.stations[n];this.create_station_marker(a,e.station_markers,s,!1)}for(var n=0;n<t.lines.length;n++){var r=t.lines[n];this.draw_line(r,!1,!0,e.line_paths,s,t)}}get_insertion_result(t,e){for(var s=[],i=[],a=-1,n=t.length(),r=0;r<t.stops.length;r++){for(var o=0;o<t.stops.length;o++)if(r!=o&&t.stops[r].sid!=e.sid&&t.stops[o].sid!=e.sid){for(var l=[t.stops[r],t.stops[o]],_=new Edge([e,t.stops[r]],!0),d=new Edge([e,t.stops[o]],!0),c=n+_.length()+d.length(),h=null,p=0;p<t.edges.length;p++)t.edges[p].compare_stops(l)&&(c-=t.edges[p].length(),h=t.edges[p]);(c<a||0==s.length)&&(a=c,s=[_,d],i=[h])}if(t.stops[r].sid!=e.sid){var v=new Edge([e,t.stops[r]],!0);((c=n+v.length())<a||0==s.length)&&(a=c,s=[v],i=[])}}return new LineDelta(s,i)}lines_for_station_by_station_pair(t){for(var e=[],s=0;s<this.station_pairs.length;s++)if(this.station_pairs[s].has_station(t))for(var i=this.station_pairs[s].lines(),a=0;a<i.length;a++)-1==e.indexOf(i[a])&&e.push(i[a]);return e}create_station_marker(t,e,s,i){var a=new StationMarker(t,s);s&&(a.marker.on("click",function(t){a.marker.closeTooltip(),enmodal.transit_interface.map.off("click",handle_map_click),setTimeout(function(){enmodal.transit_interface.map.on("click",handle_map_click)},1e3),a.generate_popup()}),a.marker.on("mousedown",function(t){enmodal.transit_interface.preview_paths_enabled=!1,enmodal.transit_interface.preview_clear(),enmodal.transit_interface.map.dragging.disable();let{lat:e,lng:s}=a.marker._latlng,{lat:i,lng:n}=t.latlng;enmodal.transit_interface.map.on("mousemove",t=>{if("station"==enmodal.transit_interface.active_tool){null==enmodal.transit_interface.moving_station_marker&&(enmodal.transit_interface.moving_station_marker=a);let{lat:g,lng:u}=t.latlng,f=i-g,y=n-u,E=[e-f,s-y];a.marker.setLatLng(E),a.marker.closeTooltip(),enmodal.transit_interface.map.closePopup(),a.station.move_to(E[0],E[1]);for(var r=enmodal.transit_interface.lines_for_station_by_station_pair(a.station),o=[],l=0;l<r.length;l++){enmodal.transit_interface.draw_line(r[l],!0,!1,enmodal.transit_interface.layers.active.line_paths,!0,enmodal.transit_interface.active_service);for(var _=enmodal.transit_interface.get_station_pairs_for_line(r[l]),d=0;d<_.length;d++)_[d]in o||o.push(_[d])}for(l=0;l<o.length;l++)o[l].draw();if(enmodal.transit_interface.draw_transfers(),ALLOW_STATION_MERGING){for(var c=!1,h=enmodal.transit_interface.map.latLngToLayerPoint(L.latLng(E[0],E[1])),l=0;l<enmodal.transit_interface.active_service.stations.length;l++){var p=enmodal.transit_interface.active_service.stations[l],v=enmodal.transit_interface.map.latLngToLayerPoint(L.latLng(p.location[0],p.location[1])),m=h.distanceTo(v);p.sid!=a.station.sid&&(m<STATION_MERGE_THRESHOLD?(enmodal.transit_interface.get_station_marker_by_station(p).show_merge(),enmodal.transit_interface.get_station_marker_by_station(p).marker.bringToFront(),enmodal.transit_interface.station_to_merge=p,c=!0):enmodal.transit_interface.get_station_marker_by_station(p).clear_merge())}c||(enmodal.transit_interface.station_to_merge=null)}}})}));for(var n=0;n<this.station_markers.length;n++)t==this.station_markers[n].station&&(this.station_markers[n]=a);return this.station_markers.push(a),a.marker.addTo(e),i&&a.marker.openPopup(),a}get_station_marker_by_station(t){for(var e=0;e<this.station_markers.length;e++)if(t==this.station_markers[e].station)return this.station_markers[e];return null}get_station_marker_by_marker(t){for(var e=0;e<this.station_markers.length;e++)if(t==this.station_markers[e].marker)return this.station_markers[e];return null}add_new_station(t,e){var s,i=new Station("...",[t,e]),a=this.active_line;s=new Stop(i),this.active_service.add_station(i),a.add_stop(s);var n=[a],r=[];if(a.stops.length>1){var o=this.get_insertion_result(a,s);r=o.add;for(var l=o.remove,_=0;_<r.length;_++){r[_].sid=enmodal.id_factory.id(),a.add_edge(r[_]);for(m=0;m<r[_].stops.length;m++)for(var d=this.get_station_pairs(r[_].stops[m].station),c=0;c<d.length;c++)for(var h=d[c][0].line_spline_segments,p=0;p<h.length;p++){var v=h[p].line;-1==n.indexOf(v)&&n.push(v)}}for(_=0;_<l.length;_++){for(var m=0;m<l[_].stops.length;m++)for(var g=l[_].stops[m].station,u=this.active_service.station_lines(g),c=0;c<u.length;c++)-1==n.indexOf(u[c])&&n.push(u[c]);if(a.remove_edge(l[_]),INC_UPDATES){f=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:a.sid,edge_id:l[_].sid});$.ajax({url:"edge_remove?"+f,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}}var f=$.param({i:enmodal.session_id,service_id:this.active_service.sid,station_id:i.sid,lat:t,lng:e});$.ajax({url:"station_add?"+f,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){i.name=t.name,"locality"in t&&(i.locality=t.locality),"neighborhood"in t&&(i.neighborhood=t.neighborhood),"region"in t&&(i.region=t.region);var n=enmodal.transit_interface.get_station_marker_by_station(i);n.generate_popup(),n.update_tooltip(),enmodal.sidebar.update_line_diagram();var o=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,line_id:a.sid,station_id:i.sid,stop_id:s.sid});INC_UPDATES&&$.ajax({url:"stop_add?"+o,async:!1,dataType:"json",success:function(t,e){for(var s=0;s<r.length;s++){var i=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,line_id:a.sid,stop_1_id:r[s].stops[0].sid,stop_2_id:r[s].stops[1].sid,edge_id:r[s].sid});$.ajax({url:"edge_add?"+i,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}})}});this.create_station_marker(i,this.layers.active.station_markers,!0,!0);for(_=0;_<n.length;_++)this.draw_line(n[_],!1,!0,this.layers.active.line_paths,!0,this.active_service);return this.purge_station_pairs(),enmodal.data.get_ridership(),enmodal.sidebar.update_line_diagram(),i}merge_stations(t,e){for(o=0;o<this.active_service.lines.length;o++)for(var s=this.active_service.lines[o],i=0;i<s.stops.length;i++){var a=s.stops[i];if(a.station.sid==t.sid&&(a.station=e,INC_UPDATES)){var n=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:s.sid,station_id:e.sid,stop_id:a.sid});$.ajax({url:"stop_update_station?"+n,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}this.remove_station(t.sid);for(var r=this.active_service.station_lines(e),o=0;o<r.length;o++)this.draw_line(r[o],!1,!0,this.layers.active.line_paths,!0,this.active_service)}update_station_info(t){var e=t.location[0],s=t.location[1],i=$.param({i:enmodal.session_id,lat:e,lng:s});$.ajax({url:"lat_lng_info?"+i,async:ASYNC_OPTIONAL,dataType:"json",success:function(e,s){t.name=e.name,"locality"in e&&(t.locality=e.locality),"neighborhood"in e&&(t.neighborhood=e.neighborhood),"region"in e&&(t.region=e.region),INC_UPDATES&&enmodal.transit_interface.sync_station_info(t)}})}sync_station_info(t){var e=$.param({i:enmodal.session_id,service_id:this.active_service.sid,station_id:t.sid,name:t.name,location:t.location[0].toString()+","+t.location[1].toString(),neighborhood:t.neighborhood});$.ajax({url:"station_update?"+e,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){enmodal.data.get_ridership()}})}add_stop_to_station(t){var e=this.active_service.get_station_by_id(t);if(null!=e){var s=new Stop(e);this.active_line.add_stop(s);var i=[this.active_line],a=[];if(this.active_line.stops.length>1){var n=this.get_insertion_result(this.active_line,s);a=n.add;for(var r=n.remove,o=0;o<a.length;o++){a[o].sid=_id_factory.id();for(c=0;c<a[o].stops.length;c++)for(var l=a[o].stops[c].station,_=this.active_service.station_lines(l),d=0;d<_.length;d++)-1==i.indexOf(_[d])&&i.push(_[d]);this.active_line.add_edge(a[o])}for(o=0;o<r.length;o++){for(var c=0;c<r[o].stops.length;c++)for(var l=r[o].stops[c].station,_=this.active_service.station_lines(l),d=0;d<_.length;d++)-1==i.indexOf(_[d])&&i.push(_[d]);if(this.active_line.remove_edge(r[o]),INC_UPDATES){h=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:this.active_line.sid,edge_id:r[o].sid});$.ajax({url:"edge_remove?"+h,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}}if(INC_UPDATES){var h=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:this.active_line.sid,station_id:e.sid,stop_id:s.sid});$.ajax({url:"stop_add?"+h,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){for(var s=0;s<a.length;s++){var i=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,line_id:enmodal.transit_interface.active_line.sid,stop_1_id:a[s].stops[0].sid,stop_2_id:a[s].stops[1].sid,edge_id:a[s].sid});$.ajax({url:"edge_add?"+i,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}})}for(o=0;o<this.station_markers.length;o++)this.station_markers[o].station.sid==e.sid&&this.station_markers[o].generate_popup();for(o=0;o<i.length;o++)this.draw_line(i[o],!1,!0,this.layers.active.line_paths,!0,this.active_service);this.purge_station_pairs(),enmodal.data.get_ridership(),enmodal.sidebar.update_line_diagram()}}remove_station(t){for(var e=[],s=[],i=0;i<this.active_service.lines.length;i++)for(var a=this.active_service.lines[i],n=0;n<a.stops.length;n++)if((f=a.stops[n]).station.sid==t){if(s.push(f),a.stops.splice(n,1),INC_UPDATES){T=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:this.active_line.sid,stop_id:f.sid});$.ajax({url:"stop_remove?"+T,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}-1==e.indexOf(a)&&e.push(a),n-=1}for(i=0;i<e.length;i++){for(var a=e[i],r=[],n=0;n<a.edges.length;n++)for(var o=a.edges[n],l=0;l<s.length;l++)if(o.has_stop(s[l])){r.push(o);for(w=0;w<o.stops.length;w++)for(var _=this.get_station_pairs(o.stops[w].station),d=0;d<_.length;d++)for(var c=_[d][0].line_spline_segments,h=0;h<c.length;h++){var p=c[h].line;-1==e.indexOf(p)&&e.push(p)}a.remove_edge(o);T=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:this.active_line.sid,edge_id:o.sid});INC_UPDATES&&$.ajax({url:"edge_remove?"+T,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}}),n-=1}if(r.length>1){var v=r[Math.floor(Math.random()*r.length)],m=v.stops[0];m.station.sid==t&&(m=v.stops[1]);for(w=0;w<r.length;w++)if((o=r[w]).sid!=v.sid){var g=o.stops[0];if(g.station.sid==t&&(g=o.stops[1]),g.sid!=m.sid&&!a.path_between_stops(g,m)){var u=new Edge([m,g]);if(a.add_edge(u),INC_UPDATES){T=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:this.active_line.sid,stop_1_id:u.stops[0].sid,stop_2_id:u.stops[1].sid,edge_id:u.sid});$.ajax({url:"edge_add?"+T,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}}for(w=0;w<a.stops.length;w++){for(var f=a.stops[w],y=!0,d=0;d<a.edges.length;d++)(o=a.edges[d]).has_stop(f)&&(y=!1);if(y){for(var E=this.get_insertion_result(a,f),S=E.add,b=E.remove,i=0;i<S.length;i++)if(S[i].sid=NS_id.id(),a.add_edge(S[i]),INC_UPDATES){T=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:a.sid,stop_1_id:S[i].stops[0].sid,stop_2_id:S[i].stops[1].sid,edge_id:S[i].sid});$.ajax({url:"edge_add?"+T,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}for(i=0;i<b.length;i++)if(a.remove_edge(b[i]),INC_UPDATES){T=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:a.sid,edge_id:b[i].sid});$.ajax({url:"edge_remove?"+T,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}}for(var w=0;w<a.edges.length;w++)if((o=a.edges[w]).stops[0].sid==o.stops[1].sid&&(a.remove_edge(o),INC_UPDATES)){T=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:a.sid,edge_id:o.sid});$.ajax({url:"edge_remove?"+T,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}}for(i=0;i<this.active_service.stations.length;i++){var L=this.active_service.stations[i];if(L.sid==t){if(this.active_service.stations.splice(i,1),INC_UPDATES){var T=$.param({i:enmodal.session_id,service_id:this.active_service.sid,station_id:L.sid});$.ajax({url:"station_remove?"+T,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}this.active_service.remove_transfers_for_station(L)&&this.draw_transfers()}}for(i=0;i<this.station_markers.length;i++){var k=this.station_markers[i];k.station.sid==t&&(this.layers.active.station_markers.removeLayer(k.marker),this.station_markers.splice(i,1))}for(i=this.station_pairs.length-1;i>=0;i--){var I=this.station_pairs[i];I.stations[0].sid!=t&&I.stations[1].sid!=t||(this.station_pairs[i].undraw(),this.station_pairs.splice(i,1))}for(i=0;i<e.length;i++)this.draw_line(e[i],!1,!0,this.layers.active.line_paths,!0,this.active_service);enmodal.data.get_ridership(),enmodal.sidebar.update_line_diagram()}remove_line_from_station(t,e){var s=this.active_service.get_line_by_id(e),i=this.active_service.get_station_by_id(t),a=s.get_stops_by_station(i),n=this.active_service.station_lines(i);if(1==n.length)return this.remove_station(t),0;for(E=0;E<a.length;E++){p=a[E];if(s.remove_stop(p),INC_UPDATES){S=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:s.sid,stop_id:p.sid});$.ajax({url:"stop_remove?"+S,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}for(var r=[],o=0;o<s.edges.length;o++)if((g=s.edges[o]).has_stop(p)){if(r.push(g),s.remove_edge(g),INC_UPDATES){S=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:s.sid,edge_id:g.sid});$.ajax({url:"edge_remove?"+S,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}o-=1}}if(r.length>1){var l=r[Math.floor(Math.random()*r.length)],_=l.stops[0];_.station.sid==t&&(_=l.stops[1]);for(h=0;h<r.length;h++)if((g=r[h]).sid!=l.sid){var d=g.stops[0];if(d.station.sid==t&&(d=g.stops[1]),d.sid!=_.sid){var c=new Edge([_,d]);if(s.add_edge(c),INC_UPDATES){S=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:s.sid,stop_1_id:c.stops[0].sid,stop_2_id:c.stops[1].sid,edge_id:c.sid});$.ajax({url:"edge_add?"+S,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}}for(var h=0;h<s.stops.length;h++){for(var p=s.stops[h],v=!0,m=0;m<s.edges.length;m++){var g=s.edges[m];g.has_stop(p)&&(v=!1)}if(v){for(var u=this.get_insertion_result(s,p),f=u.add,y=u.remove,E=0;E<f.length;E++)if(f[E].sid=NS_id.id(),s.add_edge(f[E]),INC_UPDATES){S=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:s.sid,stop_1_id:f[E].stops[0].sid,stop_2_id:f[E].stops[1].sid,edge_id:f[E].sid});$.ajax({url:"edge_add?"+S,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}for(E=0;E<y.length;E++)if(s.remove_edge(y[E]),INC_UPDATES){var S=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:s.sid,edge_id:y[E].sid});$.ajax({url:"edge_remove?"+S,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}}}}for(E=0;E<n.length;E++)this.draw_line(n[E],!1,!0,this.layers.active.line_paths,!0,this.active_service);this.get_station_marker_by_station(i).generate_popup(),enmodal.data.get_ridership(),enmodal.sidebar.update_line_diagram()}update_station_markers(t){for(var e=0;e<t.stops.length;e++){var s=t.stops[e].station,i=this.get_station_marker_by_station(s),a=num_unique_colors(this.active_service.station_lines(s));i.marker.setRadius(3*Math.max(a,2))}}has_station_pair(t,e){for(var s=0;s<this.station_pairs.length;s++){var i=this.station_pairs[s];if(i.stations[0]==t&&i.stations[1]==e)return!0;if(i.stations[0]==e&&i.stations[1]==t)return!0}return!1}get_station_pair(t,e){for(var s=0;s<this.station_pairs.length;s++){var i=this.station_pairs[s];if(i.stations[0]==t&&i.stations[1]==e)return[i,0];if(i.stations[0]==e&&i.stations[1]==t)return[i,1]}return null}get_station_pair_by_sp_id(t){for(var e=0;e<this.station_pairs.length;e++)if(this.station_pairs[e].sid==t)return this.station_pairs[e];return null}get_station_pairs(t){for(var e=[],s=0;s<this.station_pairs.length;s++){var i=this.station_pairs[s];i.stations[0]==t&&e.push([i,0]),i.stations[1]==t&&e.push([i,1])}return e}get_station_pairs_for_line(t){for(var e=[],s=this.active_service.station_drawmap(t),i=0;i<s.length;i++)for(var a=s[i],n=0;n<a.length-1;n++){var r=a[n],o=a[n+1];if(this.has_station_pair(r,o)){var l=this.get_station_pair(r,o)[0];e.push(l)}}return e}draw_line(t,e,s,i,a,n){if(t.sid in this.line_paths)r=this.line_paths[t.sid];else{var r=new LinePath;this.line_paths[t.sid]=r}for(_=0;_<r.edge_paths.length;_++)this.layers.active.line_paths.removeLayer(r.edge_paths[_].path);for(_=0;_<this.station_pairs.length;_++)this.station_pairs[_].has_line(t)&&(this.station_pairs[_].clear_spline_segment_for_line(t),this.station_pairs[_].generate_paths(a),s&&this.station_pairs[_].draw(i));var o=[];if(t.stops.length>1){for(var l=n.station_drawmap(t),_=0;_<l.length;_++){for(var d=l[_],c=[],h={},p=0,v=0;v<d.length;v++)if(c.push({x:d[v].location[0],y:d[v].location[1]}),d[v].sid in h?h[d[v].sid].push(p):h[d[v].sid]=[p],p+=1,v<d.length-1){var m=d[v],g=d[v+1];if(this.has_station_pair(m,g)){for(var u=(S=this.get_station_pair(m,g))[0],f=[],y=0;y<u.pins.length;y++)f.push({x:u.pins[y].location[0],y:u.pins[y].location[1]}),p+=1;S[1]&&(f=f.reverse()),c.push.apply(c,f)}}for(var E=new BezierSpline({points:c,sharpness:BEZIER_SHARPNESS,duration:2}),v=0;v<d.length-1;v++){var m=d[v],g=d[v+1];if(this.has_station_pair(m,g))var S=this.get_station_pair(m,g),u=S[0],b=S[1];else{u=new StationPair(n,[m,g],this.layers.active.line_paths);this.station_pairs.push(u);b=0}for(var w=h[m.sid][0],L=h[g.sid][0],T=[],y=0;y<L-w;y++)if(w+y+1<=E.centers.length){var $=[],k=[];$.push(new BezierCenter(c[w+y].x,c[w+y].y)),k.push(new BezierControlPoint(E.controls[w+y][1].x,E.controls[w+y][1].y)),k.push(new BezierControlPoint(E.controls[w+y+1][0].x,E.controls[w+y+1][0].y)),$.push(new BezierCenter(c[w+y+1].x,c[w+y+1].y)),1==b&&($=$.reverse(),k=k.reverse());var I=new SplineSegment(k,$);T.push(I)}1==b&&(T=T.reverse());var N=new LineSplineSegment(t,T,b);u.add_line_spline_segment(N),u.generate_paths(a),o.push(u),h[m.sid].splice(0,1)}}this.update_station_markers(t)}if(s)for(_=0;_<o.length;_++)o[_].draw(i),e&&o[_].draw_pins(i)}draw_transfers(){this.layers.active.transfers.clearLayers();for(var t=0;t<enmodal.transit_interface.active_service.transfers.length;t++)this.draw_transfer(enmodal.transit_interface.active_service.transfers[t])}draw_transfer(t){var e=t.stations[0],s=t.stations[1],i={weight:TRANSFER_WIDTH,color:"black",opacity:1};station_distance(e,s)>MAX_TRANSFER_DISTANCE_MILES&&(i.dashArray="10,10",i.opacity=TRANSFER_PREVIEW_OPACITY);var a=L.polyline([L.latLng(e.location),L.latLng(s.location)],i);this.layers.active.transfers.addLayer(a)}draw_transfers_for_station(t){this.transfer_layer.clearLayers();for(var e=0;e<enmodal.transit_interface.active_service.transfers.length;e++)enmodal.transit_interface.active_service.transfers[e].has_station(t)&&this.draw_transfer(enmodal.transit_interface.active_service.transfers[e])}purge_bad_transfers(){this.active_service.remove_transfers_above_length(MAX_TRANSFER_DISTANCE_MILES)>0&&this.draw_transfers()}purge_station_pairs(){for(var t=this.station_pairs.length-1;t>=0;t--){var e=this.station_pairs[t];null!=this.active_service.get_station_by_id(e.stations[0].sid)&&null!=this.active_service.get_station_by_id(e.stations[1].sid)&&0!=this.active_service.has_edge_for_stations(e.stations[0],e.stations[1])&&0!=e.lines().length||(e.undraw_pins(),this.station_pairs.splice(t,1))}}direct_station_pairs(){}regenerate_edge_path(t,e){this.line_paths[t.sid];this.layers.active.line_paths.removeLayer(e.path),e.regenerate_path(),this.layers.active.line_paths.addLayer(e.path)}refresh_edge_paths(t){for(var e=this.line_paths[t.sid],s=0;s<e.edge_paths.length;s++)this.layers.active.line_paths.removeLayer(e.edge_paths[s].path);for(var i=0;i<e.edge_paths.length;i++){e.edge_paths[i].regenerate_path();var a=e.edge_paths[i].path;this.layers.active.line_paths.addLayer(a)}}pin_projection(t,e){for(var s=this.map.latLngToLayerPoint(L.latLng(t,e)),i=null,a=-1,n=null,r=-1,o=[],l=0;l<this.station_pairs.length;l++){var _=this.station_pairs[l];if(_.service==this.active_service){var d=_.project_pin(t,e);if(null!=d&&((null==i||d.d<a)&&(i=d,a=d.d,r=_.sid,n=_),(v=s.distanceTo(this.map.latLngToLayerPoint(L.latLng(d.x,d.y))))<PIN_DISTANCE_TO_SHOW_PINS&&o.push(_.sid),DEBUG_PIN_PROJECTIONS)){var c=1;v<PIN_DISTANCE_TO_SHOW_PINS&&(c=2);m=L.polyline([L.latLng([d.x,d.y]),L.latLng(t,e)],{weight:c,color:"#00f"});this.layers.preview.addLayer(m)}}}var h=!1;if(null!=i){var s=this.map.latLngToLayerPoint(L.latLng(t,e)),p=this.map.latLngToLayerPoint(L.latLng(i.x,i.y)),v=s.distanceTo(p);h=v<PIN_DISTANCE_MIN}if(DEBUG_PIN_PROJECTIONS&&null!=i){var m=L.polyline([L.latLng([i.x,i.y]),L.latLng(t,e)],{weight:1,color:"#f00"});this.layers.preview.addLayer(m)}if(h){var g=n.distance_to_nearest_pin(t,e);g>-1&&g<PIN_DISTANCE_FROM_EXISTING_PIN_MIN&&(h=!1)}return[h,i,r,o]}preview_line(t,e,s){this.preview_clear();for(var i=this.map.latLngToLayerPoint(L.latLng(e,s)),a=0,n=null,r=0;r<enmodal.transit_interface.active_service.stations.length;r++){var o=enmodal.transit_interface.active_service.stations[r],l=i.distanceTo(this.map.latLngToLayerPoint(L.latLng(o.location[0],o.location[1])));(a>l||null==n)&&(n=o,a=l)}var _=this.pin_projection(e,s);if(_[0]&&a>PIN_DISTANCE_FROM_STATION_MIN){if(!this.dragging_pin){var d=L.marker([_[1].x,_[1].y],{icon:PIN_ICON});d.id="pin-preview",this.preview_line_pin_marker=d,this.layers.preview.addLayer(d)}}else for(var o=new Station("preview",[e,s],!0),c=new Stop(o,!0),h=this.get_insertion_result(t,c),p=0;p<h.add.length;p++){var v=h.add[p],m=[[v.stops[0].station.location[0],v.stops[0].station.location[1]],[v.stops[1].station.location[0],v.stops[1].station.location[1]]],g=new EdgePath(v.sid,m,[],[],t.color_bg,.2);this.preview_paths.push(g),this.layers.preview.addLayer(g.path)}for(p=0;p<this.station_pairs.length;p++){var u=this.station_pairs[p];_[3].indexOf(u.sid)>-1?u.draw_pins():u.undraw_pins()}}preview_transfer(t,e){this.preview_clear();var s={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[this.active_transfer_station.location[1],this.active_transfer_station.location[0]]}},i={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[e,t]}},a={type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[this.active_transfer_station.location[1],this.active_transfer_station.location[0]],[e,t]]}},n=turf.lineChunk(a,MAX_TRANSFER_DISTANCE_MILES,"miles"),r=(turf.distance(s,i,"miles"),L.polyline([L.latLng(n.features[0].geometry.coordinates[1][1],n.features[0].geometry.coordinates[1][0]),L.latLng(this.active_transfer_station.location[0],this.active_transfer_station.location[1])],{weight:TRANSFER_WIDTH,color:"black",opacity:TRANSFER_PREVIEW_OPACITY}));this.layers.preview.addLayer(r)}preview_clear(){this.layers.preview.clearLayers(),this.preview_paths=[]}preview_handler(t){this.preview_paths_enabled&&("station"==this.active_tool&&null!=this.active_line&&this.preview_line(this.active_line,t.latlng.lat,t.latlng.lng),"transfer"==this.active_tool&&this.preview_transfer(t.latlng.lat,t.latlng.lng))}draw_bezier_rep_for_station(t){for(var e=this.get_station_pairs(t),s=0;s<e.length;s++){var i=[];e[s][0].stations[0].sid==t.sid&&i.push(e[s][0].markers()[0].marker.getLatLng()),e[s][0].stations[1].sid==t.sid&&i.push(e[s][0].markers()[1].marker.getLatLng()),i.push(L.latLng(t.location[0],t.location[1])),this.bezier_layer.addLayer(L.polyline(i,{color:"#A77",weight:1,dashArray:"4,4"}))}}draw_bezier_rep(t,e,s,i){var a=[],n=1;t.stations[0].sid!=s.sid&&i||(a.push(L.latLng(t.stations[0].location[0],t.stations[0].location[1])),n=0);for(var r=t.markers(),o=0;o<Math.min(e,r.length);o++)1==n?a.push(r[r.length-o-1].marker.getLatLng()):a.push(r[o].marker.getLatLng());(e>=r.length||!i)&&t.stations[1].sid==s.sid&&a.push(L.latLng(t.stations[1].location[0],t.stations[1].location[1])),this.bezier_layer.addLayer(L.polyline(a,{color:"red",weight:1,dashArray:"2,2"}))}settings(){return{station_pairs:this.station_pairs}}}class LineDelta{constructor(t,e){this.add=t,this.remove=e}}class StationMarker{constructor(t,e){this.station=t,this.active=e,this.tooltip_options={direction:"top",offset:L.point(0,-5),className:"station-marker-tooltip"},this.marker=this.generate_marker(),this.popup=L.popup({className:"station-popup"}),this.merge_pending=!1,this.marker.bindPopup(this.popup),this.generate_popup()}generate_marker(){var t=L.latLng(this.station.location[0],this.station.location[1]),e=1;this.active||(e=INACTIVE_OPACITY);var s=L.circleMarker(t,{draggable:!0,color:"black",opacity:e,fillColor:"white",fillOpacity:e,zIndexOffset:100,pane:"stationMarkerPane"}).setRadius(MARKER_RADIUS_DEFAULT).bindTooltip(this.station.name,this.tooltip_options);return this.active&&s.on("click",function(t){if("transfer"==enmodal.transit_interface.active_tool){s.unbindPopup();var e=enmodal.transit_interface.get_station_marker_by_marker(s).station;if(e!=enmodal.transit_interface.active_transfer_station){var i={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[e.location[1],e.location[0]]}},a={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[enmodal.transit_interface.active_transfer_station.location[1],enmodal.transit_interface.active_transfer_station.location[0]]}};turf.distance(i,a,"miles")<=MAX_TRANSFER_DISTANCE_MILES&&(enmodal.transit_interface.active_service.add_transfer(e,enmodal.transit_interface.active_transfer_station),enmodal.transit_interface.draw_transfers()),enmodal.transit_interface.active_tool="station",enmodal.transit_interface.preview_clear()}}}),s}show_merge(){this.marker.setRadius(this.marker.getRadius()+MARKER_MERGE_DELTA),this.merge_pending=!0}clear_merge(){this.merge_pending&&(this.marker.setRadius(this.marker.getRadius()-MARKER_MERGE_DELTA),this.merge_pending=!1)}generate_popup(){var t='<div class="station-name" id="station-'+this.station.sid.toString()+'">'+this.station.name+'   <i class="fa fa-pencil" style="margin-left: 5px;" aria-hidden="true"></i></div>';t+='<div class="station-content"><div class="station-info">'+this.station.neighborhood+"<br />",t+='<i class="fa fa-user" aria-hidden="true"></i> <span id="stationriders-'+this.station.sid.toString()+'">',-1==this.station.ridership?t+="...":t+=Math.round(this.station.ridership).toString(),t+="</span></div>",t+='<div class="station-info subway-lines">';for(var e=enmodal.transit_interface.active_service.station_lines(this.station),s=!0,i=0;i<e.length;i++){var a=e[i];t+='<div transit-station-id="'+this.station.sid.toString()+'" transit-line-id="'+a.sid.toString()+'" class="subway-line-long subway-deletable station-popup-line-marker" style="background-color: '+a.color_bg+"; color: "+a.color_fg+';" data-balloon="Remove" data-balloon-pos="down"><div class="content">'+a.name+"</div></div>",a.sid==enmodal.transit_interface.active_line.sid&&(s=!1)}null==enmodal.transit_interface.active_line&&(s=!1),t+=" </div>",s&&(t+='<div class="station-content-button station-build line-'+enmodal.transit_interface.active_line.sid.toString()+'" id="'+this.station.sid.toString()+'">Build <div class="subway-line-long subway-line-mini" style="background-color: '+enmodal.transit_interface.active_line.color_bg+"; color: "+enmodal.transit_interface.active_line.color_fg+';"><div class="content">'+enmodal.transit_interface.active_line.name+"</div></div></div>"),t+='<div class="station-content-button station-delete" transit-station-id="'+this.station.sid.toString()+'">Delete</div>',t+='<div class="station-buttons"><div class="station-content-button station-transfer" id="transfer-'+this.station.sid.toString()+'">Transfer</div>',t+='</div><div style="clear: both;"></div>',t+="</div>",this.popup.setContent(t),this.popup.update(),this.marker.bindPopup(this.popup)}update_tooltip(){this.marker.setTooltipContent(this.station.name)}}var GAME_VERSION=.13,INC_UPDATES=!0,ASYNC_REQUIRED=!0,ASYNC_OPTIONAL=!1,CURVE_THRESHOLD=.005,MARKER_RADIUS_DEFAULT=6,MARKER_RADIUS_LARGE=8,MARKER_RADIUS_HUGE=12,MARKER_MERGE_DELTA=4,STATION_MARKER_LARGE_THRESHOLD=3,STATION_MARKER_HUGE_THRESHOLD=4,STATION_MARKER_SCALE_THRESHOLD=6,TRACK_WIDTH=6,TRACK_OFFSET=6,TRANSFER_WIDTH=3,TRANSFER_PREVIEW_OPACITY=.75,MAX_TRANSFER_DISTANCE_MILES=.25,USE_CURVED_TRACKS=!0,CURVE_OVERSHOOT=.5,BEZIER_SHARPNESS=.4,DGGRID_AREA=.0733633,MAX_ZOOM=16,MIN_ZOOM=6,START_ZOOM=13,MIN_ZOOM_FOR_HEXAGONS=13,DEBUG_MODE=!1,SHARED_STRETCH_THRESHOLD=8,ENC_NEIGHBORHOODS_ALWAYS_LABEL=["Astoria"],ENC_NEIGHBORHOODS_ONLY_LABEL=["Roosevelt Island","Governors Island","Randall's Island","North Brother Island","South Brother Island","Rikers Island","John F. Kennedy International Airport","Floyd Bennett Field","LaGuardia Airport"],ENC_LANDMARKS_ONLY_LABEL=["Ellis Island","Liberty Island","Governors Island","Grand Army Plaza","Bartel Pritchard Square","Mets-Willets Point"];ENC_LANDMARKS_NEVER_LABEL=["JFK Airport","LaGuardia Airport"];var TRANSFER_BUTTON_DEFAULT="Start Transfer",TRANSFER_BUTTON_START="Click a station",TRANSFER_BUTTON_END="Click another station",RIDERSHIP_ADD=0,RIDERSHIP_NOCHANGE=1,RIDERSHIP_DELETE=2,PERCENTAGE_EMPLOYMENT_TRIPS=.2,EMPLOYMENT_BY_BOROUGH_MODIFIERS={"Staten Island":1,Queens:5.551,Brooklyn:5.606,Bronx:2.476,Manhattan:22.189},TRANSIT_MODIFIERS={"John F. Kennedy International Airport":35e3,"LaGuardia Airport":25e3},CUSTOM_LINE_FIRST_INDEX=97,FOLLOW_STREET_MOVE_THRESH=20,PIN_DISTANCE_MIN=16,PIN_DISTANCE_FROM_STATION_MIN=8,PIN_DISTANCE_TO_SHOW_PINS=100,PIN_DISTANCE_FROM_EXISTING_PIN_MIN=40,INACTIVE_OPACITY=.25,BEZIER_LUT_STEPS=100,STATION_MERGE_THRESHOLD=8,ALLOW_STATION_MERGING=!1,SERVICE_MODES_ENABLED=!1,PIN_ICON=L.icon({iconUrl:"static/img/pin.png",iconSize:[30,25],iconAnchor:[15,25]}),DEFAULT_LINE_BG="#808183",DEFAULT_LINE_FG="#FFF";HEXAGON_SCALES={population:chroma.scale("YlGnBu").domain([1,0]),employment:chroma.scale("YlOrRd").domain([1,0])},HEXAGON_UNITS={population:"persons / mile<sup>2</sup>",employment:"jobs /  mile<sup>2</sup>"};var DEBUG_BEZIER_CONTROLS=!1,DEBUG_PIN_PROJECTIONS=!1;class Sharing{constructor(){}update(t,e){console.log(location.origin),$("#share-link-public input").val(location.origin+"/?id="+t),$("#share-link-private input").val(location.origin+"/?id="+e)}}class Sidebar{constructor(){}add_to_line_selector(t){$("#dropdown-line-menu").prepend('<li class="line-selector-item"><a class="line-selector-option" transit-line-id="'+t.sid.toString()+'" href="#"> <div class="subway-line-long" style="background-color: '+t.color_bg+"; color: "+t.color_fg+';"><div class="content">'+t.name+"</div></div> "+t.full_name+"</a></li>")}new_line_name(){for(var t=[],e=0;e<enmodal.transit_interface.active_service.lines.length;e++){var s=enmodal.transit_interface.active_service.lines[e];1==s.name.length&&(isNaN(s.name)?t[s.name.charCodeAt(0)-65]=1:t[parseInt(s.name)+25]=1)}for(e=0;e<t.length;e++)if(1!=t[e])return e<26?String.fromCharCode(65+e):(e-25).toString();return t.length<26?String.fromCharCode(65+t.length):(t.length-25).toString()}random_color(){var t=Math.floor(200*Math.random()),e=Math.floor(200*Math.random()),s=Math.floor(200*Math.random());return new LineColor(t,e,s)}line_selector_new(){var t=new Line(this.new_line_name());t.full_name="Line";var e=this.random_color();if(t.color_bg=e.bg_hex(),t.color_fg=e.fg_hex(),INC_UPDATES){var s=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,name:t.name,full_name:t.full_name,color_bg:t.color_bg,color_fg:t.color_fg,line_id:t.sid});$.ajax({url:"line_add?"+s,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}return enmodal.transit_interface.active_service.add_line(t),this.add_to_line_selector(t),this.update_line_selector(t.sid),enmodal.transit_interface.preview_clear(),t}clear_line_selector(){enmodal.transit_interface.active_line=null,$("#dropdown-line-menu li.line-selector-item").remove(),$("#dropdown-line-button").html('Select a line... <span class="caret"></span>'),$("#custom-line-name").removeClass("issue"),$("#custom-line-error").text(""),$("#custom-line-name").val(""),$("#custom-line-options #color-picker-bg").spectrum("set","#808183"),$("#custom-line-options #color-picker-fg").spectrum("set","#FFF"),this.update_line_editor(),this.update_line_diagram()}update_line_selector(t){var e=enmodal.transit_interface.active_service.get_line_by_id(t);enmodal.transit_interface.active_line=e,$("#dropdown-line-button").html('<div class="subway-line-long" style="background-color: '+e.color_bg+"; color: "+e.color_fg+';"><div class="content">'+e.name+"</div></div> "+e.full_name+' <span class="caret"></span>'),$("#custom-line-name").removeClass("issue"),$("#custom-line-error").text(""),$("#custom-line-name").val(e.name),$("#custom-line-options #color-picker-bg").spectrum("set",e.color_bg),$("#custom-line-options #color-picker-fg").spectrum("set",e.color_fg),this.update_line_editor(),this.update_line_diagram(),enmodal.transit_interface.preview_clear()}update_line_editor(){var t=$("#custom-line-name").val().substring(0,20);$("#custom-line-marker-content").text(t);var e=$("#color-picker-bg").val();$("#custom-line-marker").css("background-color",e);var s=$("#color-picker-fg").val();$("#custom-line-marker").css("color",s)}refresh_line_editor(){$(".line-selector-item").remove();for(var t=0;t<enmodal.transit_interface.active_service.lines.length;t++){var e=enmodal.transit_interface.active_service.lines[t];$("#dropdown-line-menu").prepend('<li class="line-selector-item"><a class="line-selector-option" transit-line-id="'+e.sid.toString()+'" href="#"> <div class="subway-line-long" style="background-color: '+e.color_bg+"; color: "+e.color_fg+';"><div class="content">'+e.name+"</div></div> "+e.full_name+"</a></li>")}null!=enmodal.transit_interface.active_line?($("#custom-line-options #color-picker-bg").spectrum("set",enmodal.transit_interface.active_line.color_bg),$("#custom-line-options #color-picker-fg").spectrum("set",enmodal.transit_interface.active_line.color_fg)):($("#custom-line-options #color-picker-bg").spectrum("set",DEFAULT_LINE_BG),$("#custom-line-options #color-picker-fg").spectrum("set",DEFAULT_LINE_FG))}line_editor_save(){var t=enmodal.transit_interface.active_line,e=$("#custom-line-name").val().substring(0,20),s=$("#custom-line-options #color-picker-bg").val(),i=$("#custom-line-options #color-picker-fg").val(),a=!1;0==e.length&&($("#custom-line-name").addClass("issue"),$("#custom-line-error").text("Enter a name."),a=!0),a?$("#option-section-lines").animate({scrollTop:$("#option-section-lines").prop("scrollHeight")},1e3):(t.name=e,t.color_bg=s,t.color_fg=i,$("#custom-line-name").removeClass("issue"),$("#custom-line-css-bg").removeClass("issue"),$("#custom-line-css-text").removeClass("issue"),$("#custom-line-error").text(""),this.update_line_selector(t.sid),$("a[transit-line-id='"+t.sid.toString()+"']").html('<div class="subway-line-long" style="background-color: '+t.color_bg+"; color: "+t.color_fg+';"><div class="content">'+t.name+"</div></div> "+t.full_name),enmodal.transit_interface.draw_line(t,!1,!0,enmodal.transit_interface.layers.active.line_paths,!0,enmodal.transit_interface.active_service))}update_line_diagram(){function t(s){n[n.length-1].push(s),i[s.sid]=1;for(var a=e.neighbors(s),o=0,l=0;l<a.length;l++){var _=a[l];i[_.sid]||(o>0&&(n.push([]),n[n.length-1].push(s),r.push(s.sid)),o+=1,t(_))}}var e=enmodal.transit_interface.active_line;if(null!=e)if(0!=e.stops.length){for(var s=e.outer_stops()[0],i={},a=0;a<e.stops.length;a++)i[e.stops[a].sid]=0;var n=[[]],r=[];e.stops.length>0&&t(s),$("#route-diagram").empty();var o=0,l={},_=$('<div class="route-diagram-branch"></div>');$("#route-diagram").append(_);for(var d=0;d<n.length;d++){var c=n[d],h=0;d>0&&(h=1);for(a=h;a<c.length;a++){var p=c[a];if(a==h+1&&d>0&&(_=$('<div class="route-diagram-branch"></div>'),$("#route-diagram").append(_)),r.indexOf(p.sid)>-1){_=$('<div class="route-diagram-branch"></div>'),$("#route-diagram").append(_);var v=$('<div class="route-diagram-branch-connectors"></div>');_.append(v),v.append('<div class="route-diagram-connector-top-joint" style="background-color: '+e.color_bg+';"></div>'),v.append('<div class="route-diagram-connector-branch"><div class="route-diagram-connector-internal" style="background-color: '+e.color_bg+';"></div></div>'),v.append('<div class="route-diagram-connector-bottom-joint" style="background-color: '+e.color_bg+';"></div>')}var m=$('<div class="route-diagram-stop"></div>');_.append(m),m.append('<div class="route-diagram-station-marker"></div>'),a!=c.length-1&&m.append('<div class="route-diagram-connector" style="background-color: '+e.color_bg+'"></div>');var g=$('<div class="route-diagram-stop-info" id="station-'+p.station.sid.toString()+'"></div>');m.append(g),g.append('<div class="route-diagram-stop-name">'+p.station.name+"</div>");var u=$('<div class="route-diagram-stop-connectors"></div>');g.append(u),u.append('<div class="subway-line-long subway-line-mini subway-line-marker-diagram subway-line-marker-diagram-fake" style="font-size: 1em;"><div class="content"></div></div>');for(var f=[],y=0;y<enmodal.transit_interface.active_service.lines.length;y++)enmodal.transit_interface.active_service.lines[y].sid!=e.sid&&enmodal.transit_interface.active_service.lines[y].has_station(p.station)&&f.push(enmodal.transit_interface.active_service.lines[y]);for(y=0;y<enmodal.transit_interface.active_service.transfers.length;y++)if(enmodal.transit_interface.active_service.transfers[y].has_station(p.station))for(var E=enmodal.transit_interface.active_service.transfers[y].stations,S=0;S<E.length;S++)if(E[S]!=p.station)for(var b=enmodal.transit_interface.active_service.station_lines(E[S]),w=0;w<b.length;w++)-1==f.indexOf(b[w])&&f.push(b[w]);for(y=0;y<f.length;y++)u.append('<div class="subway-line-long subway-line-mini subway-line-marker-diagram" style="font-size: 1em; background-color: '+f[y].color_bg+"; color: "+f[y].color_fg+';"><div class="content">'+f[y].name+"</div></div>");l[p.sid]=o,o+=1}}}else $("#route-diagram").empty();else $("#route-diagram").empty()}add_to_service_selector(t){$("#dropdown-service-menu").prepend('<li class="service-selector-item"><a class="service-selector-option" transit-service-id="'+t.sid.toString()+'" href="#">'+t.name+"</a></li>")}service_selector_new(){var t=new Service("Service");if(INC_UPDATES){var e=$.param({i:enmodal.session_id,service_id:t.sid,name:t.name});$.ajax({url:"service_add?"+e,async:ASYNC_REQUIRED,dataType:"json",success:function(t,e){}})}return enmodal.transit_map.add_service(t),this.add_to_service_selector(t),this.update_service_selector(t.sid,!0),enmodal.transit_interface.active_line=null,this.clear_line_selector(),enmodal.transit_interface.preview_clear(),enmodal.transit_interface.draw_service(t,enmodal.transit_interface.layers.active,!0,!0),t}update_service_selector(t,e){var s=enmodal.transit_map.get_service_by_id(t);enmodal.transit_interface.active_service=s,$("#dropdown-service-button").html(s.name+' <span class="caret"></span>'),$("#custom-service-name").removeClass("issue"),$("#custom-service-error").text(""),$("#custom-service-name").val(s.name),$(".service-mode-button").removeClass("active"),"heavy_rail"==s.mode&&$("#service-option-heavy-rail").addClass("active"),"light_rail"==s.mode&&$("#service-option-light-rail").addClass("active"),"bus"==s.mode&&$("#service-option-bus").addClass("active"),s.lines.length>0?(this.update_line_selector(s.lines[0].sid),enmodal.transit_interface.active_line=s.lines[0]):(this.clear_line_selector(),enmodal.transit_interface.active_line=null),enmodal.transit_interface.preview_clear(),e&&enmodal.transit_interface.draw_service(s,enmodal.transit_interface.layers.active,!0,!0),this.update_line_editor(),this.refresh_line_editor(),this.update_line_diagram(),enmodal.leaflet_map.closePopup()}refresh_service_editor(){$(".service-selector-item").remove();for(var t=0;t<enmodal.transit_map.services.length;t++){var e=enmodal.transit_map.services[t];$("#dropdown-service-menu").prepend('<li class="service-selector-item"><a class="service-selector-option" transit-service-id="'+e.sid+'" href="#">'+e.name+"</a></li>")}}service_editor_save(){var t=enmodal.transit_interface.active_service,e=$("#custom-service-name").val().substring(0,20),s=!1;0==e.length&&($("#custom-service-name").addClass("issue"),$("#custom-service-error").text("Enter a name."),s=!0),s?$("#option-section-services").animate({scrollTop:$("#option-section-services").prop("scrollHeight")},1e3):(t.name=e,$("#custom-service-name").removeClass("issue"),$("#custom-service-css-bg").removeClass("issue"),$("#custom-service-css-text").removeClass("issue"),$("#custom-service-error").text(""),this.update_service_selector(t.sid,!1),$("a[transit-service-id='"+t.sid+"']").html(t.name))}}class StationPair{constructor(t,e,s){this.sid=_id_factory.id(),this.service=t,this.stations=e,this.line_spline_segments=[],this.paths=[],this.street_path=null,this.pins=[],this.draw_counter=0,this.group_sss=null,this.layer=s}set_layer(t){this.undraw(),this.layer=t}add_line_spline_segment(t){this.line_spline_segments.push(t),this.line_spline_segments.sort(function(t,e){return t.line.sid>e.line.sid})}clear_spline_segment_for_line(t){for(var e=this.line_spline_segments.length-1;e>=0;e--)this.line_spline_segments[e].line==t&&this.line_spline_segments.splice(e,1)}clear_spline_segments(){this.line_spline_segments=[]}lines(){for(var t=[],e=0;e<this.line_spline_segments.length;e++){var s=this.line_spline_segments[e].line;-1==t.indexOf(s)&&t.push(s)}return t}has_line(t){for(var e=0;e<this.line_spline_segments.length;e++)if(this.line_spline_segments[e].line==t)return!0;return!1}has_station(t){for(var e=0;e<this.stations.length;e++)if(this.stations[e].sid==t.sid)return!0;return!1}num_lines(){for(var t=[],e=0;e<this.line_spline_segments.length;e++){var s=this.line_spline_segments[e].line;-1==t.indexOf(s)&&t.push(s)}return t.length}num_lines_color(){for(var t=0,e=[],s=0;s<this.line_spline_segments.length;s++){var i=this.line_spline_segments[s].line;-1==e.indexOf(i.color_bg)&&(e.push(i.color_bg),t+=1)}return t}ss_pos(t){for(var e=[],s=0;s<this.line_spline_segments.length;s++){var i=this.line_spline_segments[s].line;-1==e.indexOf(i)&&e.push(i)}for(var a=0;a<e.length;a++)if(e[a]==i.line)return a;return-1}lss_pos_color(t){for(var e=[],s=0;s<this.line_spline_segments.length;s++){var i=this.line_spline_segments[s].line;-1==e.indexOf(i.color_bg)&&e.push(i.color_bg)}for(var a=0;a<e.length;a++)if(e[a]==t.line.color_bg)return a;return-1}average_sss(){for(var t=[],e=0;e<this.line_spline_segments.length;e++)for(var s=this.line_spline_segments[e],i=0;i<s.spline_segments.length;i++){var a=s.spline_segments[i];if(t.length<=i){for(var n=[],r=[],o=0;o<a.centers.length;o++)r.push(new BezierCenter(a.centers[o].lat,a.centers[o].lng));for(o=0;o<a.controls.length;o++)n.push(new BezierControlPoint(a.controls[o].lat,a.controls[o].lng));t.push(new SplineSegment(n,r))}else for(o=0;o<a.controls.length;o++)t[i].controls[o].lat+=a.controls[o].lat,t[i].controls[o].lng+=a.controls[o].lng}for(i=0;i<t.length;i++)for(var l=t[i],o=0;o<l.controls.length;o++)t[i].controls[o].lat=t[i].controls[o].lat/this.line_spline_segments.length,t[i].controls[o].lng=t[i].controls[o].lng/this.line_spline_segments.length;return this.group_sss=t,t}project_pin(t,e){for(var s=this.average_sss(),i=-1,a=null,n=0;n<s.length;n++){var r=s[n];if(1==r.controls.length)o=new Bezier(r.centers[0].lat,r.centers[0].lng,r.controls[0].lat,r.controls[0].lng,r.centers[1].lat,r.centers[1].lng);else var o=new Bezier(r.centers[0].lat,r.centers[0].lng,r.controls[0].lat,r.controls[0].lng,r.controls[1].lat,r.controls[1].lng,r.centers[1].lat,r.centers[1].lng);var l=o.project({x:t,y:e});(null==a||l.d<i)&&(i=l.d,a=l)}return a}distance_to_nearest_pin(t,e){this.average_sss();for(var s=-1,i=0;i<this.pins.length;i++){var a=this.pins[i],n=enmodal.leaflet_map.latLngToLayerPoint(L.latLng(t,e)),r=enmodal.leaflet_map.latLngToLayerPoint(L.latLng(a.location[0],a.location[1])),o=n.distanceTo(r);(-1==s||o<s)&&(s=o)}return s}increment_draw_counter(){return this.draw_counter=this.draw_counter+1,this.draw_counter>FOLLOW_STREET_MOVE_THRESH&&(this.draw_counter=0,!0)}generate_path(t,e,s,i,a){var n=null;if("bus"==this.service.mode){if(n=this.street_path,this.increment_draw_counter()||null==this.street_path){var r=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,station_1_lat:this.stations[0].location[0],station_1_lng:this.stations[0].location[1],station_2_lat:this.stations[1].location[0],station_2_lng:this.stations[1].location[1]}),o=this;$.ajax({url:"street_path?"+r,async:!0,dataType:"json",success:function(t,r){for(var l=[],_=0;_<t[0].length;_++)l.push([t[0][_][1],t[0][_][0]]);n=L.polyline(l,{weight:i,color:e,opacity:a,offset:s*(i/2)}),o.paths=[n],o.draw_paths(o.layer)}})}}else{for(var l=this.average_sss(),_=[],d=0;d<l.length;d++){var c=l[d];_.push("M"),_.push([c.centers[0].lat,c.centers[0].lng]);var h=[];1==c.controls.length&&h.push("Q"),2==c.controls.length&&h.push("C");for(var p=0;p<c.controls.length;p++)h.push([c.controls[p].lat,c.controls[p].lng]);h.push([c.centers[1].lat,c.centers[1].lng]),_.push.apply(_,h)}var v={color:e,weight:i,opacity:a,fill:!1,smoothFactor:1,offset:s*(i/2),clickable:!1,"pointer-events":"none",className:"no-hover"};n=L.curve(_,v)}return n}add_pin(t,e){for(var s=this.average_sss(),i=-1,a=null,n=0;n<s.length;n++){var r=s[n];if(1==r.controls.length)o=new Bezier(r.centers[0].lat,r.centers[0].lng,r.controls[0].lat,r.controls[0].lng,r.centers[1].lat,r.centers[1].lng);else var o=new Bezier(r.centers[0].lat,r.centers[0].lng,r.controls[0].lat,r.controls[0].lng,r.controls[1].lat,r.controls[1].lng,r.centers[1].lat,r.centers[1].lng);for(var l=o.getLUT(BEZIER_LUT_STEPS),_=0;_<l.length-1;_++){var d=enmodal.leaflet_map.distance(L.latLng(t,e),L.latLng(l[_].x,l[_].y));(-1==i||d<i)&&(a=_+n*BEZIER_LUT_STEPS,i=d)}}var c=new Pin([t,e]);this.generate_pin_marker(c);var h=Math.floor(a/BEZIER_LUT_STEPS);this.pins.splice(h,0,c),this.draw_lines()}remove_pin(t){var e=this.pins.indexOf(t);e>-1&&this.pins.splice(e,1)}generate_paths(t){this.undraw_paths(),this.paths=[];var e=1;t||(e=INACTIVE_OPACITY);for(var s=0;s<this.line_spline_segments.length;s++){var i=this.line_spline_segments[s],a=2*this.lss_pos_color(i)-(this.num_lines_color()-1),n=this.generate_path(i,i.line.color_bg,a,6,e);if(null!=n&&this.paths.push(n),DEBUG_BEZIER_CONTROLS)for(var r=0;r<i.spline_segments.length;r++)for(var o=i.spline_segments[r],l=0;l<o.controls.length;l++){var _="#000";l>0&&(_="#fff"),this.paths.push(L.circleMarker([o.controls[l].lat,o.controls[l].lng],{color:_,opacity:.75,fillColor:i.line.color_bg,fillOpacity:1,radius:4})),this.paths.push(L.polyline([[o.controls[l].lat,o.controls[l].lng],[o.centers[l].lat,o.centers[l].lng]],{color:"#aaa",opacity:.75}))}}}undraw_paths(){for(var t=0;t<this.paths.length;t++)this.layer.removeLayer(this.paths[t])}draw_paths(t){for(var e=0;e<this.paths.length;e++)this.layer.addLayer(this.paths[e])}undraw_pins(){for(var t=0;t<this.pins.length;t++)this.pins[t].undraw()}get_pin_by_leaflet_id(t){for(var e=0;e<this.pins.length;e++)if(this.pins[e].marker._leaflet_id==t)return this.pins[e];return null}generate_pin_marker(t){var e=L.marker([t.location[0],t.location[1]],{draggable:!0,icon:PIN_ICON});e.id="pin-"+t.sid.toString(),t.marker=e;var s=this;return e.on("drag",function(t){s.get_pin_by_leaflet_id(t.target._leaflet_id).location=[t.latlng.lat,t.latlng.lng],s.draw_lines(),enmodal.transit_interface.dragging_pin=!0}),e.on("click",function(t){var e=s.get_pin_by_leaflet_id(t.target._leaflet_id);e.undraw(),s.remove_pin(e);for(var i=s.lines(),a=s.service==enmodal.transit_interface.active_service,n=0;n<i.length;n++){var r=i[n];enmodal.transit_interface.draw_line(r,!0,!0,s.layer,a,s.service)}s.draw_pins()}),e.on("dragend",function(t){enmodal.transit_interface.dragging_pin=!1}),e}draw_lines(){for(var t=this.lines(),e=this.service==enmodal.transit_interface.active_service,s=0;s<t.length;s++){var i=t[s];enmodal.transit_interface.draw_line(i,!0,!0,this.layer,e,this.service)}}draw_pins(){for(var t=0;t<this.pins.length;t++)this.pins[t].draw()}undraw(){this.undraw_paths(),this.undraw_pins()}draw(){this.draw_paths()}toJSON(){for(var t=[],e=0;e<this.stations.length;e++)t.push(this.stations[e].sid);for(var s=[],e=0;e<this.pins.length;e++)s.push(this.pins[e].toJSON());return{sid:this.sid,station_ids:t,pins:s}}}class Map{constructor(){this.sid=_id_factory.id(),this.services=[]}add_service(t){this.services.push(t)}primary_service(){return this.services[0]}get_service_by_id(t){for(var e=0;e<this.services.length;e++)if(this.services[e].sid==t)return this.services[e];return null}get_station_by_id(t){for(var e=0;e<this.services.length;e++){var s=this.services[e].get_station_by_id(t);if(null!=s)return s}return null}to_json(){return JSON.stringify(this)}from_json(t){this.sid=t.sid,this.services=[];for(var e=0;e<t.services.length;e++){var s=new Service(t.services[e].name);s.sid=t.services[e].sid,s.from_json(t.services[e]),this.add_service(s)}}}class Station{constructor(t,e,s){this.sid=void 0===s||0==s?_id_factory.id():0,this.name=t,this.location=e,this.streets=[],this.neighborhood="",this.locality="",this.region="",this.ridership=-1}move_to(t,e){this.location=[t,e]}to_json(){return JSON.stringify(this)}from_json(t){this.sid=t.sid,this.name=t.name,this.location=[parseFloat(t.location[0]),parseFloat(t.location[1])],this.streets=t.streets,this.neighborhood=t.neighborhood,this.locality=t.locality,this.region=t.region}}class Stop{constructor(t,e){this.sid=void 0===e||0==e?_id_factory.id():0,this.station=t}toJSON(){return{sid:this.sid,station_id:this.station.sid}}from_json(t,e){this.sid=t.sid,this.station=e.get_station_by_id(t.station_id),void 0==this.station&&console.log(t)}}class Line{constructor(t){this.sid=_id_factory.id(),this.name=t,this.full_name=t,this.color_bg="#000000",this.color_fg="#FFFFFF",this.group_id=0,this.stops=[],this.edges=[]}add_stop(t){this.stops.push(t)}remove_stop(t){var e=this.stops.indexOf(t);e>-1&&this.stops.splice(e,1)}has_stop(t){for(var e=0;e<this.stops.length;e++)if(this.stops[e].sid==t.sid)return!0;return!1}get_stop_by_id(t){for(var e=0;e<this.stops.length;e++)if(this.stops[e].sid==t)return this.stops[e];return null}get_stops_by_station(t){for(var e=[],s=0;s<this.stops.length;s++)this.stops[s].station.sid==t.sid&&e.push(this.stops[s]);return e}has_station(t){for(var e=0;e<this.stops.length;e++)if(this.stops[e].station.sid==t.sid)return!0;return!1}add_edge(t){this.edges.push(t)}remove_edge(t){var e=this.edges.indexOf(t);e>-1&&this.edges.splice(e,1)}has_edge(t){for(var e=0;e<this.edges.length;e++)if(this.edges[e].sid==t.sid)return!0;return!1}get_edge_by_id(t){for(var e=0;e<this.edges.length;e++)if(this.edges[e].sid==t)return this.edges[e];return null}get_edge_by_stops(t){for(var e=0;e<this.edges.length;e++)if(this.edges[e].compare_stops(t))return this.edges[e];return null}length(){for(var t=0;t<this.edges.length;t++)this.edges[t].length();return 0}neighbors(t){for(var e=[],s=0;s<this.edges.length;s++){var i=this.edges[s];i.stops[0].sid==t.sid&&e.push(i.stops[1]),i.stops[1].sid==t.sid&&e.push(i.stops[0])}return e}dijkstra(t){for(var e={},s={},i=0;i<this.stops.length;i++)e[this.stops[i].sid]=0,s[this.stops[i].sid]=0;e[t.sid]=0,s[t.sid]=1;for(i=0;i<this.stops.length;i++)for(var a=this.neighbors(this.stops[i]),n=0;n<a.length;n++){var r=e[this.stops[i].sid]+1;(r<e[a[n].sid]||!s[a[n].sid])&&(e[a[n].sid]=r,s[a[n].sid]=1)}return e}center_stop(){for(var t=-1,e=[],s=0;s<this.stops.length;s++){var i=this.stops[s],a=this.dijkstra(i),n=0;for(var r in a)n+=a[r];n<t||-1==t?(t=n,e=[i]):n==t&&e.push(i)}return e}outer_stops(){var t=[],e=[];if(0==this.stops.length)return[];if(1==this.stops.length)return[this.stops[0]];for(var s=0;s<this.edges.length;s++)for(var i=this.edges[s],a=0;a<i.stops.length;a++){var n=i.stops[a],r=t.indexOf(n),o=e.indexOf(n);-1==o&&-1==r&&t.push(n),-1==o&&r>-1&&(t.splice(r,1),e.push(n))}return 0==t.length?[this.stops[0]]:t}path_between_stops(t,e){function s(t,e,o){i.push(t),t==e&&(n=!0,a=i),r[t.sid]=1;for(var l=o.neighbors(t),_=0;_<l.length;_++){var d=l[_];r[d.sid]||n||s(d,e,o)}if(!n){var c=i.indexOf(t);i.splice(c,1)}}var i=[],a=[],n=!1,r={};return s(t,e,this),n}overlapping_stops(t){for(var e=0;e<this.stops.length;e++)if(t.station.sid==this.stops[e].station.sid)return this.stops[e];return null}toJSON(){for(var t=[],e=0;e<this.stops.length;e++)t.push(this.stops[e]);return{sid:this.sid,name:this.name,full_name:this.full_name,color_bg:this.color_bg,color_fg:this.color_fg,group_id:this.group_id,stops:t,edges:this.edges}}from_json(t,e){this.sid=t.sid,this.name=t.name,this.full_name=t.full_name,this.color_bg=t.color_bg,this.color_fg=t.color_fg,this.stops=[];for(i=0;i<t.stops.length;i++){var s=new Stop(e.get_station_by_id(t.stops[i].station_id));s.sid=t.stops[i].sid,s.from_json(t.stops[i],e),this.add_stop(s)}this.edges=[];for(var i=0;i<t.edges.length;i++){var a=new Edge([]);a.sid=t.edges[i].sid,a.from_json(t.edges[i],this),this.add_edge(a)}}}class Edge{constructor(t,e){this.sid=void 0===e||0==e?_id_factory.id():0,this.stops=t,this.path=null}length(){var t=this.stops[0].station.location,e=this.stops[1].station.location,s=L.latLng(t[0],t[1]),i=L.latLng(e[0],e[1]);return s.distanceTo(i)}has_stop(t){return this.stops[0].sid==t.sid||this.stops[1].sid==t.sid}has_station(t){return this.stops[0].station.sid==t.sid||this.stops[1].station.sid==t.sid}compare_stops(t){return t[0].sid==this.stops[0].sid&&t[1].sid==this.stops[1].sid?1:t[0].sid==this.stops[1].sid&&t[1].sid==this.stops[0].sid?2:0}toJSON(){return{sid:this.sid,stop_ids:[this.stops[0].sid,this.stops[1].sid]}}from_json(t,e){this.sid=t.sid,this.stops=[];for(var s=0;s<t.stop_ids.length;s++)this.stops.push(e.get_stop_by_id(t.stop_ids[s]))}}class Transfer{constructor(t){this.sid=_id_factory.id(),this.stations=t}has_station(t){return this.stations.indexOf(t)>-1}toJSON(){return{sid:this.sid,station_ids:[this.stations[0].sid,this.stations[1].sid]}}from_json(t,e){this.sid=t.sid,this.stations=[];for(var s=0;s<t.station_ids.length;s++)this.stations.push(e.get_station_by_id(t.station_ids[s]))}}class Service{constructor(t){this.sid=_id_factory.id(),this.name=t,this.lines=[],this.stations=[],this.transfers=[],this.mode=""}add_line(t){this.lines.push(t)}get_line_by_id(t){for(var e=0;e<this.lines.length;e++)if(this.lines[e].sid==t)return this.lines[e];return null}get_line_by_stop(t){for(var e=0;e<this.lines.length;e++)if(this.lines[e].has_stop(t))return this.lines[e];return null}has_edge_for_stations(t,e){for(var s=0;s<this.lines.length;s++)for(var i=this.lines[s].get_stops_by_station(t),a=this.lines[s].get_stops_by_station(e),n=0;n<i.length;n++)for(var r=0;r<a.length;r++)if(null!=this.lines[s].get_edge_by_stops([i[n],a[r]]))return!0;return!1}add_station(t){this.stations.push(t)}get_station_by_id(t){for(var e=0;e<this.stations.length;e++)if(this.stations[e].sid==t)return this.stations[e];return null}station_lines(t){for(var e=[],s=0;s<this.lines.length;s++)for(var i=this.lines[s],a=0;a<i.stops.length;a++)i.stops[a].station.sid==t.sid&&-1==e.indexOf(i)&&e.push(i);return e}station_drawmap(t){function e(s,r,o,l){i[i.length-1].push(s.station),l+=1,n[s.sid]=1;for(var _=t.neighbors(s),d=0,c=(a=i[i.length-1]).length,h=0,p=0;p<_.length;p++){var v=_[p];if(!n[v.sid]){var m=r.drawmap(s,v,o);m.sort(function(t,e){return t.stops.length<e.stops.length});for(var g=!1,u=0;u<m.length;u++){var f=m[u];if(f.line!=o&&!g){g=!0;for(var y=1;y<f.stops.length-1;y++)i[i.length-1].push(f.stops[y].station),l+=1}}if(d>0)i.push(a.slice(0,c)),l+=E=e(v,r,o,h=0),h+=E;else{var E=e(v,r,o,h);l+=E,h+=E}d+=1}}return l}var s=t.outer_stops()[0],i=[[]],a=[],n={};return null!=s&&e(s,this,t,0),i}drawmap(t,e,s){function i(t,e,s){a.push(t),t==e&&a.length<=l&&(r=!0,n=a),o[t.sid]=1;for(var _=s.neighbors(t),d=0;d<_.length;d++){var c=_[d];o[c.sid]||r||i(c,e,s)}if(!r){var h=a.indexOf(t);a.splice(h,1)}}for(var a=[],n=[],r=!1,o={},l=10,_=this.station_lines(t.station),d=[new Drawmap(s,[t,e])],c=0;c<_.length;c++){var h=_[c];if(h.sid!=s.sid){var p=h.overlapping_stops(t),v=h.overlapping_stops(e);if(null!=p&&null!=v){for(var o={},m=0;m<h.stops.length;m++)o[h.stops[m].sid]=0;a=[],n=[],r=!1,i(p,v,h),r&&d.push(new Drawmap(h,n))}}}return d.sort(function(t,e){return t.line.sid>e.line.sid}),d}add_transfer(t,e){for(var s=this.transfers.length-1;s>=0;s--){var i=this.transfers[s];i.has_station(t)&&i.has_station(e)&&this.transfers.splice(s,1)}t!=e&&this.transfers.push(new Transfer([t,e]))}remove_transfers_for_station(t){for(var e=0,s=this.transfers.length-1;s>=0;s--)this.transfers[s].has_station(t)&&(this.transfers.splice(s,1),e+=1);return e>0}remove_transfers_above_length(t){for(var e=0,s=this.transfers.length-1;s>=0;s--){var i=this.transfers[s];station_distance(i.stations[0],i.stations[1])>t&&(this.transfers.splice(s,1),e+=1)}return e>0}to_json(){return JSON.stringify(this)}from_json(t){this.sid=t.sid,this.name=t.name,this.mode=t.mode,this.stations=[];for(i=0;i<t.stations.length;i++){var e=new Station(t.stations[i].name,t.stations[i].location);e.sid=t.stations[i].sid,e.from_json(t.stations[i]),this.add_station(e)}this.lines=[];for(i=0;i<t.lines.length;i++){var s=new Line(t.lines[i].name);s.sid=t.lines[i].sid,s.from_json(t.lines[i],this),this.add_line(s)}if(this.transfers=[],null!=t.transfers)for(var i=0;i<t.transfers.length;i++){var a=new Transfer([]);a.from_json(t.transfers[i],this),this.transfers.push(a)}}}class Drawmap{constructor(t,e){this.line=t,this.stops=e}}class IdFactory{constructor(){this.current_id=0}id(){var t=this.current_id;return this.current_id+=1,t}}